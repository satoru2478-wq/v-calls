<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>V CALLS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        /* --- CSS STYLES --- */
        :root {
            --bg: #0a0a0a;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --accent: #fff;
            --text: #e0e0e0;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif;
            height: 100dvh; overflow: hidden; display: flex; flex-direction: column;
        }

        /* CANVAS BACKGROUND */
        #canvas-container { position: fixed; inset: 0; z-index: 0; }
        
        /* UI OVERLAY */
        #ui-layer { position: relative; z-index: 10; height: 100%; display: flex; flex-direction: column; pointer-events: none; }
        
        /* HEADER */
        header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 700; letter-spacing: -1px; font-size: 20px; }
        .status { width: 8px; height: 8px; background: #333; border-radius: 50%; transition: 0.3s; }
        .status.live { background: #00ff88; box-shadow: 0 0 10px #00ff88; }

        /* SCREENS */
        .screen {
            position: absolute; inset: 0; display: none; 
            flex-direction: column; justify-content: center; align-items: center;
            pointer-events: auto; padding: 20px;
        }
        .screen.active { display: flex; }

        /* CARDS */
        .card {
            background: rgba(10, 10, 10, 0.7);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            padding: 30px; border-radius: 24px; width: 100%; max-width: 380px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        h1 { font-size: 2.5rem; font-weight: 300; margin-bottom: 10px; letter-spacing: -1px; }
        p { color: #888; font-size: 0.9rem; margin-bottom: 25px; line-height: 1.5; }

        /* CONTROLS */
        .btn {
            width: 100%; padding: 16px; border-radius: 12px; border: none;
            background: var(--accent); color: #000; font-weight: 600; font-size: 16px;
            cursor: pointer; transition: 0.2s; margin-top: 10px;
        }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: #fff; }

        .link-display {
            background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;
            font-family: monospace; font-size: 12px; color: #aaa; margin-bottom: 10px;
            word-break: break-all;
        }

        /* CALL UI */
        .call-controls {
            position: absolute; bottom: 40px; display: flex; gap: 20px;
            background: rgba(0,0,0,0.6); padding: 15px 30px; border-radius: 50px;
            border: 1px solid var(--border); backdrop-filter: blur(10px);
        }
        .icon-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            background: rgba(255,255,255,0.1); color: #fff; font-size: 20px;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
        }
        .icon-btn.red { background: rgba(255, 50, 50, 0.2); color: #ff5555; }

        /* CHAT */
        .chat-box {
            position: absolute; bottom: 120px; width: 90%; max-width: 350px;
            background: rgba(10,10,10,0.8); border: 1px solid var(--border);
            border-radius: 20px; height: 250px; display: flex; flex-direction: column;
            backdrop-filter: blur(20px); overflow: hidden; transition: 0.3s;
        }
        .chat-box.hidden { opacity: 0; pointer-events: none; transform: translateY(20px); }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 8px 12px; border-radius: 12px; font-size: 14px; max-width: 80%; }
        .msg.me { background: #fff; color: #000; align-self: flex-end; }
        .msg.them { background: rgba(255,255,255,0.1); align-self: flex-start; }
        .chat-input {
            padding: 15px; background: transparent; border: none; border-top: 1px solid var(--border);
            color: white; outline: none; font-family: inherit;
        }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <header>
            <div class="logo">V CALLS</div>
            <div class="status" id="status-dot"></div>
        </header>

        <div id="screen-home" class="screen active">
            <div class="card">
                <h1>Sonic Void</h1>
                <p>High-fidelity, encrypted audio space.</p>
                <button class="btn" onclick="app.createRoom()">Create New Space</button>
            </div>
        </div>

        <div id="screen-lobby" class="screen">
            <div class="card">
                <p>Waiting for connection...</p>
                
                <div id="view-creator" style="display:none;">
                    <div class="link-display" id="link-text">...</div>
                    <button class="btn btn-outline" onclick="app.copyLink()">Copy Link</button>
                </div>

                <div id="view-joiner" style="display:none;">
                    <p>Secure link received.</p>
                    <button class="btn" onclick="app.joinCall()">Connect Audio</button>
                </div>
            </div>
        </div>

        <div id="screen-call" class="screen">
            <div id="chat-panel" class="chat-box hidden">
                <div class="chat-msgs" id="chat-feed"></div>
                <input type="text" class="chat-input" id="chat-in" placeholder="Type a message..." autocomplete="off">
            </div>

            <div class="call-controls">
                <button class="icon-btn" onclick="app.toggleMute()">üéôÔ∏è</button>
                <button class="icon-btn" onclick="app.toggleChat()">üí¨</button>
                <button class="icon-btn red" onclick="location.reload()">‚ùå</button>
            </div>
        </div>
    </div>

    <script>
        /** * APP LOGIC 
         * Encapsulated to prevent global scope pollution
         */
        const app = {
            // STATE
            roomID: null,
            isCreator: false,
            socket: null,
            pc: null,
            localStream: null,
            micOn: true,
            candidateQueue: [],
            
            // CONFIG
            rtcConfig: { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] },

            // INIT
            init: function() {
                // Determine Mode (Home vs Join)
                const params = new URLSearchParams(window.location.search);
                if (params.has('room')) {
                    this.roomID = params.get('room');
                    this.isCreator = false;
                    this.switchScreen('screen-lobby');
                    document.getElementById('view-joiner').style.display = 'block';
                }

                // Connect Socket
                const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
                this.socket = new WebSocket(`${protocol}//${location.host}`);
                
                this.socket.onopen = () => console.log("Socket Connected");
                this.socket.onmessage = (e) => this.handleSignal(JSON.parse(e.data));

                // Init Chat Listener
                document.getElementById('chat-in').onkeypress = (e) => {
                    if (e.key === 'Enter' && e.target.value.trim()) {
                        this.sendChat(e.target.value);
                        e.target.value = '';
                    }
                };

                // Init 3D
                visualizer.init();
            },

            // NAVIGATION
            switchScreen: function(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            },

            // ACTIONS
            createRoom: function() {
                this.roomID = Math.random().toString(36).substr(2, 9);
                this.isCreator = true;
                
                // Update URL
                const url = `${location.origin}${location.pathname}?room=${this.roomID}`;
                history.pushState(null, '', url);
                document.getElementById('link-text').innerText = url;

                this.switchScreen('screen-lobby');
                document.getElementById('view-creator').style.display = 'block';
            },

            copyLink: function() {
                navigator.clipboard.writeText(document.getElementById('link-text').innerText);
                alert("Link Copied!");
            },

            joinCall: async function() {
                this.switchScreen('screen-call');
                await this.startAudio();
                this.createPeerConnection();
                this.send({ type: 'ready' });
            },

            // WEBRTC
            startAudio: async function() {
                try {
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        audio: { echoCancellation: true, noiseSuppression: true }
                    });
                } catch(e) {
                    alert("Microphone permission denied! App cannot work.");
                }
            },

            createPeerConnection: function() {
                this.pc = new RTCPeerConnection(this.rtcConfig);
                
                // Add Local Tracks
                this.localStream.getTracks().forEach(t => this.pc.addTrack(t, this.localStream));

                // Handle Remote Tracks
                this.pc.ontrack = (e) => {
                    const audio = document.createElement('audio');
                    audio.srcObject = e.streams[0];
                    audio.autoplay = true;
                    document.body.appendChild(audio);
                    
                    document.getElementById('status-dot').classList.add('live');
                    visualizer.connectAudio(e.streams[0]);
                };

                // ICE Candidates
                this.pc.onicecandidate = (e) => {
                    if (e.candidate) this.send({ type: 'candidate', candidate: e.candidate });
                };
            },

            // SIGNALING
            handleSignal: async function(msg) {
                if (msg.room !== this.roomID) return;

                try {
                    if (msg.type === 'ready' && this.isCreator) {
                        this.switchScreen('screen-call');
                        await this.startAudio();
                        this.createPeerConnection();
                        const offer = await this.pc.createOffer();
                        await this.pc.setLocalDescription(offer);
                        this.send({ type: 'offer', sdp: offer });
                    }
                    else if (msg.type === 'offer' && !this.isCreator) {
                        if (!this.pc) this.createPeerConnection();
                        await this.pc.setRemoteDescription(msg.sdp);
                        const answer = await this.pc.createAnswer();
                        await this.pc.setLocalDescription(answer);
                        this.send({ type: 'answer', sdp: answer });
                        this.flushCandidates();
                    }
                    else if (msg.type === 'answer' && this.isCreator) {
                        await this.pc.setRemoteDescription(msg.sdp);
                        this.flushCandidates();
                    }
                    else if (msg.type === 'candidate') {
                        if (this.pc && this.pc.remoteDescription) await this.pc.addIceCandidate(msg.candidate);
                        else this.candidateQueue.push(msg.candidate);
                    }
                    else if (msg.type === 'chat') {
                        this.addChat(msg.text, false);
                    }
                } catch (e) { console.error("Signal Error", e); }
            },

            flushCandidates: async function() {
                while(this.candidateQueue.length) await this.pc.addIceCandidate(this.candidateQueue.shift());
            },

            send: function(data) {
                data.room = this.roomID;
                this.socket.send(JSON.stringify(data));
            },

            // FEATURES
            toggleMute: function() {
                const track = this.localStream.getAudioTracks()[0];
                track.enabled = !track.enabled;
                this.micOn = track.enabled;
            },
            toggleChat: function() {
                document.getElementById('chat-panel').classList.toggle('hidden');
            },
            sendChat: function(txt) {
                this.send({ type: 'chat', text: txt });
                this.addChat(txt, true);
            },
            addChat: function(txt, isMe) {
                const div = document.createElement('div');
                div.className = isMe ? 'msg me' : 'msg them';
                div.innerText = txt;
                const feed = document.getElementById('chat-feed');
                feed.appendChild(div);
                feed.scrollTop = feed.scrollHeight;
                if(!isMe) document.getElementById('chat-panel').classList.remove('hidden');
            }
        };

        /**
         * VISUALIZER (3D)
         * Cleaned up for reliability
         */
        const visualizer = {
            init: function() {
                const container = document.getElementById('canvas-container');
                const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                container.appendChild(renderer.domElement);

                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
                camera.position.z = 5;

                // Lighting
                scene.add(new THREE.AmbientLight(0x404040, 2));
                const dirLight = new THREE.DirectionalLight(0xffffff, 1);
                dirLight.position.set(5, 5, 5);
                scene.add(dirLight);

                // Object (Liquid Sphere)
                const geometry = new THREE.IcosahedronGeometry(1.5, 20);
                const material = new THREE.MeshPhysicalMaterial({
                    color: 0xffffff,
                    metalness: 0.1,
                    roughness: 0.1,
                    transmission: 0.6,
                    thickness: 1,
                    clearcoat: 1
                });
                const sphere = new THREE.Mesh(geometry, material);
                scene.add(sphere);

                // Animation
                const clock = new THREE.Clock();
                
                const animate = () => {
                    requestAnimationFrame(animate);
                    const t = clock.getElapsedTime();

                    // Audio Data
                    let freq = 0;
                    if (this.analyser) {
                        const data = new Uint8Array(this.analyser.frequencyBinCount);
                        this.analyser.getByteFrequencyData(data);
                        freq = data[10] / 255; // Bass
                    }

                    // Morph
                    const pos = geometry.attributes.position;
                    const vec = new THREE.Vector3();
                    
                    for (let i = 0; i < pos.count; i++) {
                        vec.fromBufferAttribute(pos, i);
                        vec.normalize();
                        
                        // Noise function simulation
                        const noise = Math.sin(vec.x*3 + t) + Math.cos(vec.y*3 + t);
                        const amp = 1.5 + (noise * 0.1) + (freq * 0.5);
                        
                        vec.multiplyScalar(amp);
                        pos.setXYZ(i, vec.x, vec.y, vec.z);
                    }
                    pos.needsUpdate = true;
                    sphere.rotation.y = t * 0.1;

                    renderer.render(scene, camera);
                };
                animate();
                
                window.onresize = () => {
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    camera.aspect = window.innerWidth/window.innerHeight;
                    camera.updateProjectionMatrix();
                }
            },

            connectAudio: function(stream) {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const src = ctx.createMediaStreamSource(stream);
                this.analyser = ctx.createAnalyser();
                this.analyser.fftSize = 64;
                src.connect(this.analyser);
            }
        };

        // START APP
        window.onload = () => app.init();
    </script>
</body>
</html>
